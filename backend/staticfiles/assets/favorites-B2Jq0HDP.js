const S="lang";let p=localStorage.getItem(S)||"ru";const $={"search.placeholder":{ru:"Найти город...",en:"Search city..."},"favorites.empty":{ru:"Пусто",en:"Empty"},"favorites.open":{ru:"Открыть",en:"Open"},"favorites.remove":{ru:"Удалить",en:"Remove"},"auth.required":{ru:"Нужно войти в систему",en:"You need to sign in"}};function u(a){return $[a]&&$[a][p]||a}function b(){const a=document.getElementById("search-input");a&&(a.placeholder=u("search.placeholder"));const r=document.getElementById("lang-toggle");r&&(r.textContent=p==="ru"?"EN":"RU")}function _(a){p=a,localStorage.setItem(S,a),b(),typeof rerenderFavorites=="function"&&rerenderFavorites()}const I="unit";let s=localStorage.getItem(I)||"metric";function A(){return s==="metric"?"°C":"°F"}function T(a="unitToggle",r){const l=document.getElementById(a);if(!l)return;const c=()=>{l.querySelectorAll("button[data-unit]").forEach(i=>{i.classList.toggle("active",i.dataset.unit===s)})};c(),l.addEventListener("click",i=>{const h=i.target.closest("button[data-unit]");if(!h)return;const d=h.dataset.unit;d&&d!==s&&(s=d,localStorage.setItem(I,s),c(),typeof r=="function"&&r())})}document.addEventListener("DOMContentLoaded",()=>{b(),document.getElementById("lang-toggle")?.addEventListener("click",()=>{_(p==="ru"?"en":"ru")});const r="a9c23e068a0e62f0ae23ab4a0336b395",l=document.getElementById("fav-list"),c=document.getElementById("fav-empty");let i=[];T("unitToggle",()=>{y()});const h=document.getElementById("search-btn"),d=document.getElementById("search-input"),w=()=>{const t=(d?.value||"").trim();t&&(window.location.href=`/search/?q=${encodeURIComponent(t)}`)};h?.addEventListener("click",w),d?.addEventListener("keydown",t=>{t.key==="Enter"&&w()});function L(t){const e=document.cookie.match("(^|;)\\s*"+t+"\\s*=\\s*([^;]+)");return e?e.pop():""}const k=L("csrftoken");async function v(t){await fetch("/api/favorites/remove/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":k},credentials:"same-origin",body:JSON.stringify(t)})}function E(t){if(i=t.slice(),l.innerHTML="",!t.length){c.style.display="block",c.textContent=u("favorites.empty");return}c.style.display="none";for(const e of t){const n=document.createElement("div");n.className="city-card",n.innerHTML=`
        <div class="city-title">
          <h3>${e.name}${e.country?`, ${e.country}`:""}</h3>
        </div>

        <div class="city-now">
          <img class="city-now__icon" alt="" style="width:56px;height:auto;opacity:.7" />
          <span class="city-now__temp">…</span>
        </div>

        <div class="city-actions">
          <button class="btn-ghost" data-open>${u("favorites.open")}</button>
          <button class="btn-danger" data-remove>${u("favorites.remove")}</button>
        </div>
      `,n.querySelector("[data-open]")?.addEventListener("click",()=>{window.location.href=`/search/?q=${encodeURIComponent(e.name)}`}),n.querySelector("[data-remove]")?.addEventListener("click",async()=>{try{e.id?await v({id:e.id}):await v({name:e.name,country:e.country||""}),await y()}catch(f){console.error("remove failed",f),alert("Не удалось удалить из избранного")}}),l.appendChild(n),C(e,n).catch(()=>{})}}window.rerenderFavorites=()=>E(i);async function C(t,e){const n=e.querySelector(".city-now__icon"),f=e.querySelector(".city-now__temp");let o;t.lat!=null&&t.lon!=null?o=`https://api.openweathermap.org/data/2.5/weather?lat=${t.lat}&lon=${t.lon}&appid=${r}&units=${s}&lang=${p==="ru"?"ru":"en"}`:o=`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(t.country?`${t.name},${t.country}`:t.name)}&appid=${r}&units=${s}&lang=${p==="ru"?"ru":"en"}`;const g=await fetch(o);if(!g.ok)throw new Error("weather http "+g.status);const m=await g.json();if(!m?.weather?.[0]||!m?.main)throw new Error("bad payload");const B=m.weather[0].icon,x=Math.round(m.main.temp);n.src=`https://openweathermap.org/img/wn/${B}.png`,n.alt=m.weather[0].description||"",f.textContent=`${x}${A()}`}async function q(){const t=await fetch("/api/favorites/",{method:"GET",headers:{Accept:"application/json"},credentials:"same-origin"});if(t.redirected)return window.location.href=t.url,[];const e=t.status,n=(t.headers.get("content-type")||"").toLowerCase();if(n.includes("application/json")){const o=await t.json();if(Array.isArray(o.items))return o.items;if(Array.isArray(o.results))return o.results;if(Array.isArray(o))return o;if(o.success===!1)throw new Error(o.error||"Backend error (success=false)");return console.warn("Unexpected JSON shape:",o),[]}const f=await t.text();if(console.error("Favorites: not JSON",{status:e,ct:n,preview:f.slice(0,200)}),e===401||e===403)return alert(u("auth.required")),[];throw e>=500?new Error("Сервер вернул ошибку 5xx. Проверь логи Django."):new Error(`Не JSON (status ${e}, ct ${n}).`)}async function y(){try{const t=await q();E(t)}catch(t){console.error("failed to load favorites:",t),c.style.display="block",c.textContent=`${u("favorites.empty")}`}}y()});
